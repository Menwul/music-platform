{% extends "base.html" %}

{% block styles %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/referral.css') }}">
<style>
/* Referral Page Styles */
.referral-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px;
    border-radius: 15px;
    text-align: center;
    box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.stat-icon {
    font-size: 2.5em;
    margin-bottom: 15px;
}

.stat-number {
    font-size: 2.2em;
    font-weight: bold;
    margin-bottom: 5px;
}

.stat-label {
    opacity: 0.9;
    font-size: 0.9em;
}

.referral-main {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 30px;
    margin-bottom: 40px;
}

.referral-card, .benefits-card {
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
}

.referral-header h2 {
    color: #333;
    margin-bottom: 10px;
}

.referral-header p {
    color: #666;
    margin-bottom: 25px;
}

.code-container {
    display: flex;
    align-items: center;
    background: #f8f9fa;
    border: 2px dashed #667eea;
    border-radius: 10px;
    padding: 15px 20px;
    margin-bottom: 25px;
}

.code-value {
    font-size: 1.5em;
    font-weight: bold;
    color: #333;
    flex: 1;
    font-family: 'Courier New', monospace;
}

.btn-copy-code {
    background: #667eea;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-copy-code:hover {
    background: #5a6fd8;
    transform: translateY(-2px);
}

.link-container {
    display: flex;
    margin-bottom: 25px;
}

.link-container input {
    flex: 1;
    padding: 12px 15px;
    border: 1px solid #ddd;
    border-radius: 8px 0 0 8px;
    font-size: 0.9em;
}

.btn-copy-link {
    background: #667eea;
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 0 8px 8px 0;
    cursor: pointer;
}

.share-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px;
}

.btn-share {
    padding: 12px;
    border: none;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-share:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.whatsapp { background: #25D366; }
.facebook { background: #3b5998; }
.twitter { background: #1DA1F2; }
.telegram { background: #0088cc; }
.email { background: #ea4335; }

.benefits-card h3 {
    margin-bottom: 20px;
    color: #333;
}

.benefit-item {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    padding: 15px;
    background: #f8f9fa;
    border-radius: 10px;
}

.benefit-icon {
    background: #667eea;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    flex-shrink: 0;
}

.benefit-content h4 {
    margin: 0 0 5px 0;
    color: #333;
}

.benefit-content p {
    margin: 0;
    color: #666;
    font-size: 0.9em;
}

.referred-friends {
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    margin-bottom: 40px;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
}

.friends-stats {
    display: flex;
    gap: 15px;
}

.stat-badge {
    background: #f8f9fa;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.9em;
    color: #666;
}

.friends-list {
    display: grid;
    gap: 15px;
}

.friend-card {
    display: flex;
    align-items: center;
    padding: 20px;
    background: #f8f9fa;
    border-radius: 10px;
    border-left: 4px solid #667eea;
}

.friend-avatar {
    width: 50px;
    height: 50px;
    background: #667eea;
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 15px;
    font-size: 1.2em;
}

.friend-info {
    flex: 1;
}

.friend-info h4 {
    margin: 0 0 5px 0;
    color: #333;
}

.friend-type {
    color: #666;
    font-size: 0.9em;
    margin: 0 0 5px 0;
}

.join-date {
    color: #999;
    font-size: 0.8em;
    margin: 0;
}

.status-badge {
    padding: 6px 12px;
    border-radius: 15px;
    font-size: 0.8em;
    font-weight: 600;
}

.status-active {
    background: #d4edda;
    color: #155724;
}

.friend-earnings {
    text-align: right;
}

.earning-amount {
    font-weight: bold;
    color: #28a745;
    font-size: 1.1em;
}

.earning-label {
    color: #666;
    font-size: 0.8em;
}

.empty-state {
    text-align: center;
    padding: 60px 20px;
    color: #666;
}

.empty-state i {
    font-size: 4em;
    color: #ddd;
    margin-bottom: 20px;
}

.empty-state h3 {
    margin-bottom: 10px;
    color: #333;
}

.faq-section, .promotion-section {
    background: white;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    margin-bottom: 40px;
}

.faq-item {
    border-bottom: 1px solid #eee;
    margin-bottom: 10px;
}

.faq-question {
    padding: 15px 0;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
    color: #333;
}

.faq-answer {
    padding: 0 0 15px 0;
    color: #666;
    display: none;
}

.faq-answer.active {
    display: block;
}

.promotion-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.promo-card {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 10px;
    border-left: 4px solid #667eea;
}

.promo-content {
    margin-top: 15px;
}

.btn-copy-promo {
    background: #667eea;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 10px;
    font-size: 0.9em;
}

.toast {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #333;
    color: white;
    padding: 15px 25px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 10px;
    opacity: 0;
    transform: translateY(20px);
    transition: all 0.3s ease;
    z-index: 1000;
}

.toast.show {
    opacity: 1;
    transform: translateY(0);
}

@media (max-width: 768px) {
    .referral-main {
        grid-template-columns: 1fr;
    }
    
    .referral-stats {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .share-buttons {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 15px;
    }
    
    .friends-stats {
        width: 100%;
        justify-content: space-between;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2><i class="fas fa-music"></i> S.S PRODUCTION</h2>
            <p class="user-type">{{ current_user.user_type|title }} Dashboard</p>
        </div>
        
        <div class="sidebar-menu">
            <a href="{{ url_for('dashboard') }}" class="menu-item">
                <i class="fas fa-{{ 'headphones' if current_user.user_type == 'streamer' else 'chart-line' }}"></i>
                {{ 'Listen & Earn' if current_user.user_type == 'streamer' else 'Analytics' }}
            </a>
            {% if current_user.user_type == 'artist' %}
            <a href="{{ url_for('upload') }}" class="menu-item">
                <i class="fas fa-upload"></i> Upload Music
            </a>
            {% endif %}
            <a href="{{ url_for('referral') }}" class="menu-item active">
                <i class="fas fa-users"></i> Referral Program
            </a>
            <a href="#" class="menu-item" onclick="showWithdrawModal()">
                <i class="fas fa-wallet"></i> Withdraw Funds
            </a>
            <a href="{{ url_for('logout') }}" class="menu-item">
                <i class="fas fa-sign-out-alt"></i> Logout
            </a>
        </div>
        
        <div class="user-balance">
            <h3>Your Balance</h3>
            <p class="balance-amount">${{ "%.2f"|format(current_user.balance) }}</p>
            <p class="referral-code">Ref Code: {{ current_user.referral_code }}</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="content-header">
            <h1>Referral Program ðŸŽ‰</h1>
            <p>Invite friends and earn more money together!</p>
        </div>

        <!-- Referral Stats -->
        <div class="referral-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-user-plus"></i>
                </div>
                <div class="stat-number">{{ referrals|length }}</div>
                <div class="stat-label">Referred Friends</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-money-bill-wave"></i>
                </div>
                <div class="stat-number">${{ "%.2f"|format(referral_earnings) }}</div>
                <div class="stat-label">Total Referral Earnings</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-gift"></i>
                </div>
                <div class="stat-number">$5.00</div>
                <div class="stat-label">Bonus Per Referral</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-number">${{ "%.2f"|format(potential_earnings) }}</div>
                <div class="stat-label">Potential Earnings</div>
            </div>
        </div>

        <!-- Referral Main Section -->
        <div class="referral-main">
            <div class="referral-card">
                <div class="referral-header">
                    <h2>Your Unique Referral Code</h2>
                    <p>Share this code with friends and earn $5 for each successful referral</p>
                </div>
                
                <div class="referral-code-display">
                    <div class="code-container">
                        <span class="code-value" id="referralCode">{{ current_user.referral_code }}</span>
                        <button class="btn-copy-code" onclick="copyReferralCode()">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>

                <div class="referral-link">
                    <h3>Or share your referral link:</h3>
                    <div class="link-container">
                        <input type="text" id="referralLink" value="{{ referral_url }}" readonly>
                        <button class="btn-copy-link" onclick="copyReferralLink()">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                </div>

                <div class="share-buttons">
                    <button class="btn-share whatsapp" onclick="shareViaWhatsApp()">
                        <i class="fab fa-whatsapp"></i> WhatsApp
                    </button>
                    <button class="btn-share facebook" onclick="shareViaFacebook()">
                        <i class="fab fa-facebook"></i> Facebook
                    </button>
                    <button class="btn-share twitter" onclick="shareViaTwitter()">
                        <i class="fab fa-twitter"></i> Twitter
                    </button>
                    <button class="btn-share telegram" onclick="shareViaTelegram()">
                        <i class="fab fa-telegram"></i> Telegram
                    </button>
                    <button class="btn-share email" onclick="shareViaEmail()">
                        <i class="fas fa-envelope"></i> Email
                    </button>
                </div>
            </div>

            <div class="benefits-card">
                <h3>How It Works ðŸ’°</h3>
                <div class="benefits-list">
                    <div class="benefit-item">
                        <div class="benefit-icon">
                            <i class="fas fa-user-plus"></i>
                        </div>
                        <div class="benefit-content">
                            <h4>Share Your Code</h4>
                            <p>Send your unique referral code to friends</p>
                        </div>
                    </div>
                    
                    <div class="benefit-item">
                        <div class="benefit-icon">
                            <i class="fas fa-user-check"></i>
                        </div>
                        <div class="benefit-content">
                            <h4>Friends Sign Up</h4>
                            <p>They use your code when registering</p>
                        </div>
                    </div>
                    
                    <div class="benefit-item">
                        <div class="benefit-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="benefit-content">
                            <h4>You Both Earn</h4>
                            <p>You get $5 instantly when they join</p>
                        </div>
                    </div>
                    
                    <div class="benefit-item">
                        <div class="benefit-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <div class="benefit-content">
                            <h4>Keep Earning</h4>
                            <p>Earn from their activity and referrals</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Referred Friends -->
        <div class="referred-friends">
            <div class="section-header">
                <h2>Your Referred Friends ({{ referrals|length }})</h2>
                <div class="friends-stats">
                    <span class="stat-badge">
                        <i class="fas fa-users"></i> Total: {{ referrals|length }}
                    </span>
                    <span class="stat-badge">
                        <i class="fas fa-money-bill-wave"></i> Earned: ${{ "%.2f"|format(referral_earnings) }}
                    </span>
                </div>
            </div>

            {% if referrals %}
            <div class="friends-list">
                {% for referral in referrals %}
                <div class="friend-card">
                    <div class="friend-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="friend-info">
                        <h4>{{ referral.referred.username }}</h4>
                        <p class="friend-type">{{ referral.referred.user_type|title }}</p>
                        <p class="join-date">Joined {{ referral.created_at.strftime('%b %d, %Y') }}</p>
                    </div>
                    <div class="friend-status">
                        <span class="status-badge status-active">
                            <i class="fas fa-check-circle"></i> Active
                        </span>
                    </div>
                    <div class="friend-earnings">
                        <div class="earning-amount">+$5.00</div>
                        <div class="earning-label">Bonus Paid</div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <h3>No referrals yet</h3>
                <p>Start sharing your referral code to invite friends and earn bonuses!</p>
                <button class="btn btn-primary" onclick="scrollToShareSection()">
                    <i class="fas fa-share-alt"></i> Share Your Code Now
                </button>
            </div>
            {% endif %}
        </div>

        <!-- FAQ Section -->
        <div class="faq-section">
            <h2>Frequently Asked Questions</h2>
            <div class="faq-list">
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>How much do I earn per referral?</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>You earn $5.00 instantly for each friend who signs up using your referral code and completes registration.</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>When do I receive my referral bonus?</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>The $5 bonus is added to your account immediately after your friend completes their registration using your referral code.</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>Is there a limit to how many people I can refer?</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>No! There's no limit. You can refer as many friends as you want and earn $5 for each successful referral.</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>Can my referred friends also refer others?</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>Yes! When your friends sign up, they get their own referral code and can start earning by referring others.</p>
                    </div>
                </div>
                
                <div class="faq-item">
                    <div class="faq-question" onclick="toggleFAQ(this)">
                        <span>What if my friend doesn't use my referral code during signup?</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="faq-answer">
                        <p>The referral code must be entered during registration. If they forget, they can't add it later, so make sure to share your code clearly.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Promotion Materials -->
        <div class="promotion-section">
            <h2>Promotion Materials</h2>
            <p>Use these ready-made messages to share with your friends</p>
            
            <div class="promotion-cards">
                <div class="promo-card">
                    <h4>ðŸ“± Social Media Post</h4>
                    <div class="promo-content">
                        <p>ðŸŽµ Earn money by listening to music! Use my referral code <strong>{{ current_user.referral_code }}</strong> on S.S PRODUCTION and get started. We both get $5! ðŸŽ§</p>
                        <button class="btn-copy-promo" onclick="copyPromoText(this, 'social')">
                            <i class="fas fa-copy"></i> Copy Text
                        </button>
                    </div>
                </div>
                
                <div class="promo-card">
                    <h4>ðŸ“§ Email Template</h4>
                    <div class="promo-content">
                        <p>Hey! I found this amazing platform called S.S PRODUCTION where you can earn money by listening to music. Use my referral code <strong>{{ current_user.referral_code }}</strong> when you sign up and we both get $5 bonus! Check it out: {{ referral_url }}</p>
                        <button class="btn-copy-promo" onclick="copyPromoText(this, 'email')">
                            <i class="fas fa-copy"></i> Copy Text
                        </button>
                    </div>
                </div>
                
                <div class="promo-card">
                    <h4>ðŸ’¬ WhatsApp Message</h4>
                    <div class="promo-content">
                        <p>Hey! Check out S.S PRODUCTION ðŸŽµ You can earn money by listening to music! Use my code *{{ current_user.referral_code }}* when signing up and we both get $5! ðŸ”¥ {{ referral_url }}</p>
                        <button class="btn-copy-promo" onclick="copyPromoText(this, 'whatsapp')">
                            <i class="fas fa-copy"></i> Copy Text
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Success Toast -->
<div id="copyToast" class="toast">
    <i class="fas fa-check-circle"></i>
    <span id="toastMessage">Copied to clipboard!</span>
</div>
{% endblock %}

{% block scripts %}
<script>
// Copy referral code
function copyReferralCode() {
    const code = document.getElementById('referralCode').textContent;
    navigator.clipboard.writeText(code).then(() => {
        showToast('Referral code copied!');
    });
}

// Copy referral link
function copyReferralLink() {
    const link = document.getElementById('referralLink');
    link.select();
    navigator.clipboard.writeText(link.value).then(() => {
        showToast('Referral link copied!');
    });
}

// Copy promotion text
function copyPromoText(button, type) {
    const card = button.closest('.promo-card');
    const text = card.querySelector('p').textContent;
    navigator.clipboard.writeText(text).then(() => {
        showToast('Text copied to clipboard!');
    });
}

// Share functions
function shareViaWhatsApp() {
    const text = `Join S.S PRODUCTION using my referral code: ${currentUserCode} and we both get $5! ${referralUrl}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
}

function shareViaFacebook() {
    const url = encodeURIComponent(referralUrl);
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}`, '_blank');
}

function shareViaTwitter() {
    const text = `Join S.S PRODUCTION using my code ${currentUserCode} and we both get $5!`;
    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(referralUrl)}`, '_blank');
}

function shareViaTelegram() {
    const text = `Join S.S PRODUCTION using my referral code: ${currentUserCode} and we both get $5! ${referralUrl}`;
    window.open(`https://t.me/share/url?url=${encodeURIComponent(referralUrl)}&text=${encodeURIComponent(text)}`, '_blank');
}

function shareViaEmail() {
    const subject = 'Join S.S PRODUCTION and Earn Money!';
    const body = `Hey! I found this amazing platform called S.S PRODUCTION where you can earn money by listening to music. Use my referral code ${currentUserCode} when you sign up and we both get $5 bonus! Check it out: ${referralUrl}`;
    window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);
}

// FAQ toggle
function toggleFAQ(element) {
    const answer = element.nextElementSibling;
    const icon = element.querySelector('i');
    
    if (answer.classList.contains('active')) {
        answer.classList.remove('active');
        icon.classList.remove('fa-chevron-up');
        icon.classList.add('fa-chevron-down');
    } else {
        // Close all other FAQs
        document.querySelectorAll('.faq-answer').forEach(ans => {
            ans.classList.remove('active');
        });
        document.querySelectorAll('.faq-question i').forEach(icn => {
            icn.classList.remove('fa-chevron-up');
            icn.classList.add('fa-chevron-down');
        });
        
        // Open current FAQ
        answer.classList.add('active');
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-up');
    }
}

// Toast notification
function showToast(message) {
    const toast = document.getElementById('copyToast');
    const toastMessage = document.getElementById('toastMessage');
    
    toastMessage.textContent = message;
    toast.classList.add('show');
    
    setTimeout(() => {
        toast.classList.remove('show');
    }, 3000);
}

// Scroll to share section
function scrollToShareSection() {
    document.querySelector('.referral-main').scrollIntoView({ 
        behavior: 'smooth' 
    });
}

// Global variables
const currentUserCode = '{{ current_user.referral_code }}';
const referralUrl = '{{ referral_url }}';

// Initialize tooltips
document.addEventListener('DOMContentLoaded', function() {
    // Add any initialization code here
});
</script>
{% endblock %}